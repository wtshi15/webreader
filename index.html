<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manga Viewer — Interruptible (last-two-numbers parser)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0 auto;
      max-width: 1100px;
      background: #111;
      color: #eee;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
    }
    header, footer {
      padding: 12px 16px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      background: #111;
    }
    footer {
      border-top: 1px solid #222;
      border-bottom: none;
      flex-direction: column;
      gap: 10px;
    }
    h1 {
      font-size: 1rem;
      margin: 0;
      font-weight: 600;
      color: #ddd;
    }
    .muted { color: #9aa; }
    #controlsTop, #controlsBottom {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button, input, select {
      background: #222;
      color: #eee;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.95rem;
    }
    button:hover { background: #2c2c2c; cursor: pointer; }
    input[type="number"] { width: 100px; }
    input[type="url"] { width: min(80vw, 560px); }
    #content { padding: 16px; }
    img.manga-page {
      display: block;
      margin: 16px auto;
      width: min(100%, 1000px);
      height: auto;
      background: #000;
      border-radius: 6px;
    }
    .spinner {
      margin: 24px auto;
      width: 36px; height: 36px;
      border: 3px solid #333; border-top-color: #9cf;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .divider { height: 1px; background: #222; width: 100%; }
    .baseRow { width: 100%; display: flex; gap: 8px; align-items: baseline; }
    code { word-break: break-all; }
    .emptyState {
      padding: 24px 16px;
      color: #aab;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <!-- TOP controls (visible only at top) -->
  <header>
    <h1 id="title">Manga Viewer — No series loaded</h1>

    <div id="controlsTop">
      <!-- URL capture -->
      <div class="row">
        <label for="sampleUrl" class="muted">Sample page URL</label>
        <input id="sampleUrl" type="url" placeholder="https://host/Series/57./1.jpg" />
        <button id="pasteBtn" title="Paste from clipboard">Paste</button>
        <button id="useBtn"   title="Use this URL (start at its chapter)">Use</button>
      </div>

      <!-- Chapter navigation -->
      <div class="row">
        <label for="chapterInputTop" class="muted">Chapter</label>
        <input id="chapterInputTop" type="number" min="1" step="1" value="1" />
        <button id="goBtnTop"   title="Jump to chapter (uses URL textbox as base)">Go</button>
      </div>
      <div class="row">
        <button id="prevBtnTop" title="Previous chapter (←)">Previous</button>
        <button id="nextBtnTop" title="Next chapter (→)">Next</button>
      </div>

      <!-- Extension strategy -->
      <div class="row">
        <label for="extSelect" class="muted">Extensions</label>
        <select id="extSelect" title="Try these file extensions in order">
          <option>.webp,.jpg,.png</option>
          <option>.webp</option>
          <option>.jpg,.png</option>
          <option>.png</option>
          <option>.jpg</option>
        </select>
      </div>
    </div>
  </header>

  <div id="content">
    <div class="emptyState" id="emptyState">
      Paste a single page URL — the viewer will treat the <b>last two numbers</b> in the path as
      <i>chapter</i> (second-last) and <i>page</i> (last), even if they’re surrounded by punctuation (e.g., <code>57.</code>).
      Click <b>Use</b> to initialize; you can interrupt loading any time with Previous/Next/Go.
    </div>
  </div>

  <!-- BOTTOM controls (visible only at bottom) -->
  <footer>
    <div id="controlsBottom" class="row" style="justify-content: flex-end; width: 100%;">
      <div class="row">
        <label for="chapterInputBottom" class="muted">Chapter</label>
        <input id="chapterInputBottom" type="number" min="1" step="1" value="1" />
        <button id="goBtnBottom" title="Jump to chapter (uses URL textbox as base)">Go</button>
      </div>
      <div class="row">
        <button id="prevBtnBottom" title="Previous chapter (←)">Previous</button>
        <button id="nextBtnBottom" title="Next chapter (→)">Next</button>
      </div>
    </div>
    <div class="divider"></div>
    <!-- Base link preview at the VERY bottom -->
    <div class="baseRow">
      <span class="muted">Base:</span>
      <code id="basePreview">(not set)</code>
    </div>
  </footer>

  <script>
    // ====== State ======
    let state = {
      origin: "",            // e.g., https://demoniclibs.com
      templateNoExt: "",     // e.g., /Catastrophic%20Necromancer/{CH}/ {PG}  (without the .ext)
      currentChapter: 1,
      orderExts: ["webp", "jpg", "png"],
      initialized: false,
      loadToken: 0,          // increments to cancel in-flight loads
      seriesLabel: "Manga Viewer",
    };

    // ====== Elements ======
    const titleEl = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const basePreview = document.getElementById("basePreview");

    const sampleUrlInput = document.getElementById("sampleUrl");
    const pasteBtn = document.getElementById("pasteBtn");
    const useBtn   = document.getElementById("useBtn");

    const prevBtnTop = document.getElementById("prevBtnTop");
    const nextBtnTop = document.getElementById("nextBtnTop");
    const goBtnTop   = document.getElementById("goBtnTop");
    const chapterInputTop = document.getElementById("chapterInputTop");
    const extSelect = document.getElementById("extSelect");

    const prevBtnBottom = document.getElementById("prevBtnBottom");
    const nextBtnBottom = document.getElementById("nextBtnBottom");
    const goBtnBottom   = document.getElementById("goBtnBottom");
    const chapterInputBottom = document.getElementById("chapterInputBottom");

    // ====== Helpers ======
    function setExtOrderFromSelect(preferredFirstExt = null) {
      const dropdownList = extSelect.value.split(",").map(s => s.trim().replace(/^\./, ""));
      if (preferredFirstExt) {
        const set = new Set([preferredFirstExt, ...dropdownList]);
        state.orderExts = Array.from(set);
      } else {
        state.orderExts = dropdownList;
      }
    }

    function updateUI() {
      const preview = state.initialized
        ? `${state.origin}${state.templateNoExt.replace("{CH}", String(state.currentChapter)).replace("{PG}", "<page>")}.{${state.orderExts.join(",")}}`
        : "(not set)";
      basePreview.textContent = preview;

      titleEl.textContent = `${state.seriesLabel} — Chapter ${state.currentChapter}`;
      chapterInputTop.value = String(state.currentChapter);
      chapterInputBottom.value = String(state.currentChapter);
    }

    function clearContent() {
      contentEl.innerHTML = "";
    }

    function addSpinner() {
      const s = document.createElement("div");
      s.className = "spinner";
      s.id = "spinner";
      contentEl.appendChild(s);
    }

    function removeSpinner() {
      const s = document.getElementById("spinner");
      if (s) s.remove();
    }

    function showEmptyState(msg) {
      const d = document.createElement("div");
      d.className = "emptyState";
      d.textContent = msg || `Paste a page URL and click Use.`;
      contentEl.appendChild(d);
    }

    // Parse by taking the last two numeric runs in the path:
    // second-last => chapter, last => page.
    // Build a template (without extension) replacing them with {CH} and {PG}, preserving punctuation.
    function parseSampleUrlLastTwoNumbers(u) {
      try {
        const url = new URL(u);
        const origin = `${url.protocol}//${url.host}`;

        // Path with percent-encoding preserved; we'll keep encoding in template
        const path = url.pathname; // e.g., "/Catastrophic%20Necromancer/57./1.jpg"

        // Find all numeric runs with indices
        const matches = [];
        const re = /\d+/g;
        let m;
        while ((m = re.exec(path)) !== null) {
          matches.push({ num: m[0], index: m.index });
        }
        if (matches.length < 2) return null;

        const pageMatch    = matches[matches.length - 1];
        const chapterMatch = matches[matches.length - 2];

        const chapter = parseInt(chapterMatch.num, 10);
        const page    = parseInt(pageMatch.num, 10);
        if (!Number.isFinite(chapter) || chapter < 1 || !Number.isFinite(page) || page < 1) {
          return null;
        }

        // Determine extension from the last '.' (if any)
        const lastDot = path.lastIndexOf(".");
        let ext = "";
        let pathNoExt = path;
        if (lastDot > pageMatch.index) {
          ext = path.slice(lastDot + 1).toLowerCase();
          pathNoExt = path.slice(0, lastDot);
        }

        // Build templateNoExt by replacing numeric runs at their indices.
        // Replace the later one first to avoid shifting indices (page is later).
        function replaceAt(str, start, length, replacement) {
          return str.slice(0, start) + replacement + str.slice(start + length);
        }
        let templateNoExt = pathNoExt;
        templateNoExt = replaceAt(templateNoExt, pageMatch.index, pageMatch.num.length, "{PG}");
        templateNoExt = replaceAt(templateNoExt, chapterMatch.index, chapterMatch.num.length, "{CH}");

        // Nice label: try to infer series name (segment before the chapter digits)
        // Take substring up to chapterMatch.index, split on '/', take last non-empty.
        let seriesLabel = "Manga Viewer";
        const preChapter = path.slice(0, chapterMatch.index);
        const parts = preChapter.split("/").filter(Boolean);
        if (parts.length) {
          try { seriesLabel = decodeURIComponent(parts[parts.length - 1]); }
          catch { /* keep default */ }
        }

        return { origin, templateNoExt, chapter, page, ext, seriesLabel };
      } catch {
        return null;
      }
    }

    // Cancel current load
    function cancelInProgressLoad() { state.loadToken += 1; }

    // Build a URL for given chapter/page/ext using the template
    function buildUrl(ch, pg, ext) {
      const pathNoExt = state.templateNoExt.replace("{CH}", String(ch)).replace("{PG}", String(pg));
      return `${state.origin}${pathNoExt}.${ext}`;
    }

    async function loadChapter(ch) {
      if (!state.initialized) {
        clearContent();
        showEmptyState(`Set a base via the URL textbox + Use.`);
        return;
      }

      cancelInProgressLoad();
      const myToken = state.loadToken;

      state.currentChapter = ch;
      updateUI();
      clearContent();
      addSpinner();

      const order = state.orderExts.slice();
      let page = 1;
      let misses = 0;
      const maxConsecutiveMisses = 1;

      function tryOnePageAllExts(pageNum, token) {
        return new Promise((resolve) => {
          let idx = 0;
          function attempt() {
            if (token !== state.loadToken) { resolve({ ok: false, canceled: true }); return; }
            if (idx >= order.length) { resolve({ ok: false }); return; }
            const ext = order[idx++];
            const url = buildUrl(ch, pageNum, ext);
            const img = new Image();
            img.className = "manga-page";
            img.alt = `Chapter ${ch}, Page ${pageNum}`;
            img.onload = () => {
              if (token !== state.loadToken) { resolve({ ok: false, canceled: true }); return; }
              resolve({ ok: true, element: img });
            };
            img.onerror = () => {
              if (token !== state.loadToken) { resolve({ ok: false, canceled: true }); return; }
              attempt();
            };
            img.referrerPolicy = "no-referrer";
            img.src = url;
          }
          attempt();
        });
      }

      while (misses <= maxConsecutiveMisses) {
        if (myToken !== state.loadToken) break;
        const res = await tryOnePageAllExts(page, myToken);
        if (myToken !== state.loadToken) break;

        if (res.ok) {
          contentEl.appendChild(res.element);
          page += 1;
          misses = 0;
        } else if (res.canceled) {
          break;
        } else {
          misses += 1;
          if (page === 1) break;
          break;
        }
      }

      if (myToken !== state.loadToken) return;
      removeSpinner();

      if (contentEl.children.length === 0) {
        showEmptyState(`No pages found for Chapter ${ch}. Check the base URL or try another chapter.`);
      }
    }

    // Re-derive base from the textbox (without changing ext order unless preferredExt is provided)
    function refreshBaseFromTextbox(preferredExt) {
      const raw = (sampleUrlInput.value || "").trim();
      const parsed = parseSampleUrlLastTwoNumbers(raw);
      if (!parsed) return false;

      state.origin       = parsed.origin;
      state.templateNoExt= parsed.templateNoExt;
      state.seriesLabel  = parsed.seriesLabel || "Manga Viewer";
      if (preferredExt) setExtOrderFromSelect(parsed.ext || preferredExt);
      return true;
    }

    // ====== Wire controls ======
    document.getElementById("pasteBtn").addEventListener("click", async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (text) sampleUrlInput.value = text.trim();
        else alert("Clipboard is empty.");
      } catch {
        alert("Clipboard read not allowed here. Paste manually.");
      }
    });

    // Use: parse URL, prefer its extension, start from its chapter
    document.getElementById("useBtn").addEventListener("click", () => {
      const parsed = parseSampleUrlLastTwoNumbers((sampleUrlInput.value || "").trim());
      if (!parsed) {
        alert("Could not parse that URL. It must contain at least two numbers (chapter, page).");
        return;
      }
      state.origin        = parsed.origin;
      state.templateNoExt = parsed.templateNoExt;
      state.seriesLabel   = parsed.seriesLabel || "Manga Viewer";
      setExtOrderFromSelect(parsed.ext || null);
      state.initialized   = true;
      state.currentChapter= parsed.chapter;

      updateUI();
      loadChapter(parsed.chapter);
    });

    // Go buttons: always re-parse from textbox (so you can switch series/host on the fly)
    function doGo(n) {
      if (!refreshBaseFromTextbox(null)) {
        alert("Invalid or missing sample URL. Paste a valid page URL first.");
        return;
      }
      state.initialized = true;
      if (Number.isFinite(n) && n >= 1) loadChapter(n);
    }
    document.getElementById("goBtnTop").addEventListener("click", () => {
      const n = parseInt(chapterInputTop.value, 10);
      doGo(n);
    });
    chapterInputTop.addEventListener("keydown", (e) => { if (e.key === "Enter") document.getElementById("goBtnTop").click(); });

    document.getElementById("goBtnBottom").addEventListener("click", () => {
      const n = parseInt(chapterInputBottom.value, 10);
      doGo(n);
    });
    chapterInputBottom.addEventListener("keydown", (e) => { if (e.key === "Enter") document.getElementById("goBtnBottom").click(); });

    // Prev / Next never block; they cancel current load immediately
    function goPrev() {
      if (!refreshBaseFromTextbox(null)) {
        alert("Invalid or missing sample URL. Paste a valid page URL first.");
        return;
      }
      state.initialized = true;
      if (state.currentChapter > 1) loadChapter(state.currentChapter - 1);
    }
    function goNext() {
      if (!refreshBaseFromTextbox(null)) {
        alert("Invalid or missing sample URL. Paste a valid page URL first.");
        return;
      }
      state.initialized = true;
      loadChapter(state.currentChapter + 1);
    }
    prevBtnTop.addEventListener("click", goPrev);
    nextBtnTop.addEventListener("click", goNext);
    prevBtnBottom.addEventListener("click", goPrev);
    nextBtnBottom.addEventListener("click", goNext);

    // Extension dropdown changes order (no auto-reload)
    extSelect.addEventListener("change", () => setExtOrderFromSelect(null));

    // Arrow keys (ignore when typing in inputs)
    window.addEventListener("keydown", (e) => {
      const typing = [sampleUrlInput, chapterInputTop, chapterInputBottom].includes(e.target);
      if (typing) return;
      if (e.key === "ArrowLeft")  goPrev();
      if (e.key === "ArrowRight") goNext();
    });

    // Initial UI
    setExtOrderFromSelect(null);
    updateUI();
  </script>
</body>
</html>
